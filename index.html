<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepRacer Reward Function Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px; height: 16px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-thumb::-moz-range-thumb {
            width: 16px; height: 16px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold">DeepRacer Reward Function Visualizer</h1>
        <p class="text-gray-600 mt-2">Testen Sie Ihre Reward-Funktion interaktiv.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Steuerung -->
        <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg space-y-6">

            <!-- Car Parameters -->
            <div>
                <h2 class="text-xl font-semibold mb-3 border-b pb-2">Car Parameters</h2>
                <div class="space-y-4">
                    <div>
                        <label>Car X Position: <span id="car-x-value">150</span></label>
                        <input type="range" id="car-x" min="0" max="1000" value="150" class="w-full slider-thumb">
                    </div>
                    <div>
                        <label>Car Y Position: <span id="car-y-value">150</span></label>
                        <input type="range" id="car-y" min="0" max="1000" value="150" class="w-full slider-thumb">
                    </div>
                    <div>
                        <label>Heading: <span id="heading-value">45°</span></label>
                        <input type="range" id="heading" min="-180" max="180" value="45" class="w-full slider-thumb">
                    </div>
                    <div>
                        <label>Speed: <span id="speed-value">5.0</span></label>
                        <input type="range" id="speed" min="0" max="10" step="0.1" value="5" class="w-full slider-thumb">
                    </div>
                    <div>
                        <label class="inline-flex items-center mt-3">
                            <input type="checkbox" id="look-at-mouse" class="form-checkbox h-5 w-5 text-indigo-600">
                            <span class="ml-2">Auto schaut immer zur Maus</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Model Auswahl -->
            <div>
                <label for="model-select" class="block text-sm font-medium text-gray-700">Reward Function wählen:</label>
                <select id="model-select" class="mt-1 block w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500"></select>
            </div>

            <!-- Reward -->
            <div class="bg-indigo-50 p-6 rounded-xl text-center">
                <h2 class="text-lg font-semibold text-indigo-800">Calculated Reward</h2>
                <p id="reward-value" class="text-4xl font-bold text-indigo-600 mt-2">0.0000</p>
            </div>
        </div>

        <!-- Canvas -->
        <div class="lg:col-span-2 bg-white p-4 rounded-2xl shadow-lg flex items-center justify-center">
            <canvas id="track-canvas" class="w-full h-full rounded-lg"></canvas>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('track-canvas');
const ctx = canvas.getContext('2d');

const carXSlider = document.getElementById('car-x');
const carYSlider = document.getElementById('car-y');
const headingSlider = document.getElementById('heading');
const speedSlider = document.getElementById('speed');
const carXValue = document.getElementById('car-x-value');
const carYValue = document.getElementById('car-y-value');
const headingValue = document.getElementById('heading-value');
const speedValue = document.getElementById('speed-value');
const rewardValue = document.getElementById('reward-value');
const lookAtMouseCheckbox = document.getElementById('look-at-mouse');
const modelSelect = document.getElementById('model-select');

let state = {
    car: { x: 3.408314959676616, y: 1.4717702850315393, heading: 45, speed: 5 },
    waypoints: [
        [3.408314959676616, 1.4717702850315393],
        [3.278316020965576, 1.471244990825653],
        [3.148323229010334, 1.4698760351357125],
        [2.974927544593811, 1.4680500030517578],
        [2.671554446220398, 1.4732159972190857],
        [2.3681689500808716, 1.4696124792099],
        [2.0653909444808973, 1.4793429970741272],
        [1.7702519893646231, 1.5481655001640322],
        [1.483372986316681, 1.6465474963188171],
        [1.1825209856033325, 1.665496051311493],
        [0.8996591567993164, 1.55953049659729],
        [0.6058058738708496, 1.493058979511261],
        [0.3036217987537384, 1.4668729901313782],
        [0.00022387993521988392, 1.4644305109977722],
        [-0.3031398057937622, 1.4698509573936462],
        [-0.6065511703491211, 1.4700390100479126],
        [-0.9099699556827545, 1.4700774550437927],
        [-1.2133870124816895, 1.4710184931755066],
        [-1.516803503036499, 1.472249984741211],
        [-1.8202179670333862, 1.4738149642944336],
        [-2.1236274242401123, 1.4759759902954102],
        [-2.427031993865967, 1.4785684943199158],
        [-2.7303649187088013, 1.472720980644226],
        [-3.0334941148757935, 1.4606574773788452],
        [-3.336466908454895, 1.4711779952049255],
        [-3.6301519870758057, 1.54459547996521],
        [-3.9102929830551147, 1.65993994474411],
        [-4.20968532562256, 1.703934550285339],
        [-4.496387481689454, 1.6192825436592089],
        [-4.708314418792725, 1.4057174921035767],
        [-4.802008390426635, 1.1188610196113604],
        [-4.860429525375366, 0.8211241662502311],
        [-4.920632362365723, 0.5237410515546799],
        [-4.97938084602356, 0.22606505453586578],
        [-5.031064033508301, -0.07268327847123146],
        [-4.979203701019287, -0.36956214904785156],
        [-4.809752941131592, -0.617946207523346],
        [-4.550312995910643, -0.7715703397989278],
        [-4.257645130157471, -0.8490209430456161],
        [-3.9584025144577026, -0.8976912498474121],
        [-3.6566635370254517, -0.9255106151103973],
        [-3.3626874685287476, -0.9994447827339172],
        [-3.0748790502548218, -1.0955036282539368],
        [-2.786156415939331, -1.1866423189640045],
        [-2.486029028892517, -1.2304852604866028],
        [-2.1842055320739746, -1.2615086436271667],
        [-1.8819324970245361, -1.2877083718776703],
        [-1.5803679823875427, -1.260584980249405],
        [-1.2913404703140259, -1.1709365844726562],
        [-0.9996453821659088, -1.0925500392913818],
        [-0.6984832286834717, -1.116917371749878],
        [-0.420046791434288, -1.2342189252376556],
        [-0.14777036756277084, -1.3665609955787659],
        [0.14819640666246414, -1.4308984875679016],
        [0.4421359449625015, -1.3735359907150269],
        [0.6987309455871582, -1.212949424982071],
        [0.9145341217517853, -1.0006998777389526],
        [1.1385363936424255, -0.7995848059654236],
        [1.4211704730987549, -0.6919995695352554],
        [1.7221534848213196, -0.6560808718204498],
        [2.024604022502899, -0.6640181243419647],
        [2.3245800733566284, -0.7095721513032913],
        [2.6152199506759644, -0.7918080240488052],
        [2.857451558113098, -0.9721536040306091],
        [2.9898489713668823, -1.240626037120819],
        [3.1674790382385254, -1.4824514985084534],
        [3.4428740739822388, -1.601032018661499],
        [3.7423360347747803, -1.6497185230255127],
        [4.044067859649658, -1.681160032749176],
        [4.347193956375122, -1.6917835474014282],
        [4.643414497375488, -1.6374415159225464],
        [4.8928515911102295, -1.4685439467430115],
        [5.023529529571533, -1.1997559666633606],
        [5.024764060974121, -0.8974809050559998],
        [4.991261959075928, -0.5959695875644686],
        [4.958872318267822, -0.29428809881210327],
        [4.9252283573150635, 0.007256770506501198],
        [4.894884347915649, 0.3091498017311096],
        [4.8511130809783936, 0.6092253923416138],
        [4.804372549057007, 0.9090217053890233],
        [4.708405017852783, 1.1938440203666687],
        [4.480142593383789, 1.3866339921951294],
        [4.187997817993164, 1.4637395143508911],
        [3.8851370811462402, 1.47393000125885],
        [3.5817264318466187, 1.472470998764038],
        [3.408314959676616, 1.4717702850315393]
    ],
    closestWaypoints: [0, 1]
};

let draggingCar = false;
let lookAtMouse = false;
let mousePos = { x: 0, y: 0 };
let currentModel = "";

// --- Hilfsfunktionen ---
function dist2d(a, b) {
    return Math.hypot(a[0] - b[0], a[1] - b[1]);
}

function updateClosestWaypoints() {
    const distances = state.waypoints.map((wp, idx) => ({ idx, dist: dist2d([state.car.x, state.car.y], wp) }));
    distances.sort((a, b) => a.dist - b.dist);
    const first = distances[0].idx;
    const second = distances[1].idx;
    state.closestWaypoints = first < second ? [first, second] : [second, first];
}

// --- Model Auswahl laden ---
function loadModels() {
    fetch('/models')
        .then(res => res.json())
        .then(models => {
            modelSelect.innerHTML = "";
            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                modelSelect.appendChild(opt);
            });
            currentModel = models[0] || "";
            fetchReward();
        });
}

modelSelect.addEventListener('change', e => {
    currentModel = e.target.value;
    fetchReward();
});

// --- Reward vom Server holen ---
function fetchReward() {
    updateClosestWaypoints();
    fetch('/reward', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            model: currentModel,
            params: {
                x: state.car.x,
                y: state.car.y,
                heading: state.car.heading,
                speed: state.car.speed,
                waypoints: state.waypoints,
                closest_waypoints: state.closestWaypoints
            }
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.reward !== undefined) {
            rewardValue.textContent = data.reward.toFixed(4);
        } else {
            rewardValue.textContent = "ERR";
            console.error(data.error);
        }
    });
}

// --- Zeichnen ---
function draw() {
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Track
    ctx.beginPath();
    ctx.moveTo(state.waypoints[0][0], state.waypoints[0][1]);
    state.waypoints.forEach(([x, y]) => ctx.lineTo(x, y));
    ctx.closePath();
    ctx.strokeStyle = '#9ca3af';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Waypoints
    state.waypoints.forEach((wp, idx) => {
        ctx.beginPath();
        ctx.arc(wp[0], wp[1], 8, 0, 2 * Math.PI);
        ctx.fillStyle = state.closestWaypoints.includes(idx) ? '#6366f1' : '#6b7280';
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.font = 'bold 10px Inter';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(idx, wp[0], wp[1]);
    });

    // Car
    ctx.save();
    ctx.translate(state.car.x, state.car.y);
    ctx.rotate(state.car.heading * Math.PI / 180);
    ctx.fillStyle = '#ef4444';
    ctx.fillRect(-15, -10, 30, 20);
    ctx.fillStyle = '#f87171';
    ctx.fillRect(-10, -8, 20, 16);
    ctx.beginPath();
    ctx.moveTo(15, 0);
    ctx.lineTo(35, 0);
    ctx.strokeStyle = '#ef4444';
    ctx.lineWidth = 3;
    ctx.stroke();
    ctx.restore();
}

function updateUI() {
    carXValue.textContent = state.car.x;
    carYValue.textContent = state.car.y;
    headingValue.textContent = `${Math.round(state.car.heading)}°`;
    speedValue.textContent = state.car.speed.toFixed(1);
    fetchReward();
}

function render() {
    draw();
    updateUI();
}

function screenToCanvas(e) {
    const rect = canvas.getBoundingClientRect();
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

// --- Events ---
carXSlider.addEventListener('input', e => { state.car.x = +e.target.value; render(); });
carYSlider.addEventListener('input', e => { state.car.y = +e.target.value; render(); });
headingSlider.addEventListener('input', e => { state.car.heading = +e.target.value; render(); });
speedSlider.addEventListener('input', e => { state.car.speed = +e.target.value; render(); });

lookAtMouseCheckbox.addEventListener('change', e => { lookAtMouse = e.target.checked; });

canvas.addEventListener('mousedown', e => {
    const pos = screenToCanvas(e);
    const dx = pos.x - state.car.x;
    const dy = pos.y - state.car.y;
    if (Math.sqrt(dx*dx + dy*dy) < 20) {
        draggingCar = true;
    }
});
canvas.addEventListener('mousemove', e => {
    mousePos = screenToCanvas(e);
    if (draggingCar) {
        state.car.x = mousePos.x;
        state.car.y = mousePos.y;
        render();
    }
});
canvas.addEventListener('mouseup', () => draggingCar = false);
canvas.addEventListener('mouseleave', () => draggingCar = false);

function animate() {
    if (lookAtMouse) {
        const dx = mousePos.x - state.car.x;
        const dy = mousePos.y - state.car.y;
        state.car.heading = Math.atan2(dy, dx) * (180 / Math.PI);
        render();
    }
    requestAnimationFrame(animate);
}

// Init
window.addEventListener('resize', render);
loadModels();
render();
animate();
</script>
</body>
</html>
